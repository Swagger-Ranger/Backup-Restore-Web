(function(a) {
	a.fn.nthTabs = function(c) {
		var h = this;
		var g = {
			allowClose : true,
			active : false,
			rollWidth : h.width() - (6*52),
		};
		var e = a.extend({}, g, c);
		var d = '<div class="page-tabs"><a href="javascript:void(0)" class="roll-nav roll-nav-left roll-nav-left-a1"><span class="fa fa-navicon"></span></a><a href="javascript:void(0)" class="roll-nav roll-nav-left roll-nav-left-a2"><span class="fa fa-backward"></span></a><div class="content-tabs"><div class="content-tabs-container"><ul class="nav nav-tabs"></ul></div></div><a href="javascript:void(0)" class="roll-nav roll-nav-right roll-nav-right3"><span class="fa fa-forward"></span></a><div id="dropdownNthTabDiv" class="dropdown roll-nav right-nav-list roll-nav-right2"><a href="javascript:void(0)" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="fa fa-chevron-down"></span></a><ul class="dropdown-menu"><li><a href="javascript:void(0)" class="tab-location">\u5b9a\u4f4d\u5f53\u524d\u6807\u7b7e\u9875</a></li><li class="closeCurLi"><a href="javascript:void(0)" class="tab-close-current">\u5173\u95ed\u5f53\u524d\u6807\u7b7e\u9875</a></li><li role="separator" class="divider"></li><li><a href="javascript:void(0)" class="tab-close-other">\u5173\u95ed\u5176\u4ed6\u6807\u7b7e\u9875</a></li><li><a href="javascript:void(0)" class="tab-close-all">\u5173\u95ed\u5168\u90e8\u6807\u7b7e\u9875</a></li><li role="separator" class="divider"></li><li class="scrollbar-outer tab-list-scrollbar"><div class="tab-list-container"><ul class="tab-list"></ul></div></li></ul></div><a href="javascript:void(0)" class="roll-nav roll-nav-right roll-nav-right1 user_info_clk"><span id="user_info" class="fa"></span><span class="fa fa-gear"></span></a></div>';
			d += '<ul id="dropdownRightCtrl" class="dropdown-menu"><li>'+
				'<a onclick="editUserH();" style="cursor:pointer;"><i class="ace-icon fa fa-cog"></i>&nbsp;&nbsp;&nbsp;修改密码</a> '+
				'</li>'+
				'<li class="divider" style="margin:0px"></li>'+
				'<li>'+
					'<a onclick="editOpen();" style="cursor:pointer;"><i class="ace-icon fa fa-folder-open-o"></i>&nbsp;&nbsp;&nbsp;默认打开</a>'+
				'</li>'+							
				'<li class="divider" style="margin:0px"></li>'+
				'<li>'+
					'<a href="javascript:void(0);" onclick =clearBiee();><i class="ace-icon fa fa-power-off"></i>&nbsp;&nbsp;&nbsp;退出登录</a>'+
				'</li></ul>';
			d += '<div id="tab-content" class="tab-content" style="padding:0px;background-color:#e5e5e5"></div>';
		var b = {
			init : function() {
				h.html(d);
				//位置改成紧贴右边，不知为什么.css('left','')删除不了left，只能这样处理：
				var btnWith = $('#tab_menu > div.page-tabs > div.dropdown.roll-nav.right-nav-list').width();
				var dropdownWidth = $('#tab_menu .dropdown-menu').width();
				$('.dropdown-menu').css('left','-'+( dropdownWidth-btnWith+2 )+'px');
				b.listen()
			},
			listen : function() {
				f.onTabClose().onTabRollLeft().onTabRollRight().onTabList()
						.onTabCloseOpt().onTabCloseAll().onTabCloseOther()
						.onLocationTab().onClickTab().onTabMouseover().onTabMouseout()
			},
			getAllTabWidth : function() {
				var i = 0;
				h.find(".nav-tabs li").each(function() {
					i += parseFloat(a(this).width())
				});
				return i
			},
			getMarginStep : function() {
				return e.rollWidth / 2
			},
			getActiveId : function() {
				return h.find('li.active').find("a").attr("href").replace("#", "")
			},
			getTabList : function() {
				var i = [];
				h.find(".nav-tabs li a").each(function() {
					i.push({
						id : a(this).attr("href"),
						title : a(this).attr("title"),
						tabNm : a(this).children("span").html()
					})
				});
				return i
			},
			addTab : function(j) {
				var k = [];
				var m = j.active == undefined ? e.active : j.active;
				var i = j.allowClose == undefined ? e.allowClose : j.allowClose;
				m = m ? "active" : "";
				var noColeClass = '';
				if(!j.isClosed){
					//没有关闭按钮的加个标志，关闭全部和关闭其他时，过滤这个不让它关闭
					noColeClass = ' noColeClass';
				}
				
				k.push('<li role="presentation" class="' + m + noColeClass +'">');
				if(!j.isHomePage){
					k.push('<span class="self-left-boder"></span>');
				}
				k.push('<a title="' + j.title + '" href="#' + j.id + '" data-toggle="tab">');
				var _title = j.title;
				if(j.title.length > 4){
					//太长只显示前5个字符
					_title = j.title.substring(0,6);
				}
//				k.push('<i class="' + j.icon + '"></i>&nbsp;<span>' + _title + '</span>');
				k.push('<span>' + _title + '</span>');
				if(j.isClosed){
					//有关闭按钮的
					i ? k.push('<i class="fa fa-close tab-close"></i>') : "";
				}
				k.push("</a>");
				k.push("</li>");
				h.find(".nav-tabs").append(k.join(""));
				var l = [];
				l.push('<iframe class="tab-pane '
								+ m
								+ noColeClass
								+ '" id="'
								+ j.id
								+ '" style="overflow-x: hidden; " allowtransparency="true" frameborder="0" width="100%" height="100%" src="'
								+ j.url + '"></iframe>');
				l.push(j.content);
				h.find(".tab-content").append(l.join(""));
				return b
			},
			locationTab : function(j) {
				j = j == undefined ? b.getActiveId() : j;
				j = j.indexOf("#") > -1 ? j : "#" + j;
				var m = h.find("[href='" + j + "']");
				var l = 0;
				m.parent().prevAll().each(function() {
					l += a(this).width()
				});
				var i = m.parent().parent().parent();
				if (l <= e.rollWidth * 0.7) {
					margin_left_total = 104
				} else {
					if (l <= e.rollWidth) {
						margin_left_total = 104 - e.rollWidth / 2
					} else {
						var k = l + m.parent().width()
								- (Math.floor(l / e.rollWidth) * e.rollWidth);
						if (k <= e.rollWidth * 0.7) {
							margin_left_total = 104
									- Math.floor(l / e.rollWidth) * e.rollWidth
						} else {
							margin_left_total = 104
									- Math.floor(l / e.rollWidth) * e.rollWidth
									- e.rollWidth / 2
						}
					}
				}
				i.css("margin-left", margin_left_total);
				b.closeClass();
				return b
			},
			closeClass : function() {
				//当前的关闭按钮样式显示，其他都改成和背景色一样的颜色
				$('.nav-tabs .tab-close').removeClass('selected');
				$('.nav-tabs .tab-close').addClass('noselected');
				$('.nav-tabs .active .tab-close').removeClass('noselected');
				$('.nav-tabs .active .tab-close').addClass('selected');
				//当前选中的、和它后面紧跟的tab的.self-left-boder隐藏掉
				$('.nav-tabs .self-left-boder').css('border-left','1px solid #ccc');
				$('.nav-tabs .active .self-left-boder').css('border-left','0px solid #ccc');
				$('.nav-tabs .active').next().find('.self-left-boder').css('border-left','0px solid #ccc');
			},
			delTab : function(j) {
				j = j == undefined ? b.getActiveId() : j;
				j = j.indexOf("#") > -1 ? j : "#" + j;
				var k = h.find("[href='" + j + "']");
				if (k.parent().attr("class") == "active") {
					var i = k.parent().next();
					var l = a(j).next();
					if (i.length < 1) {
						i = k.parent().prev();
						l = a(j).prev()
					}
					i.addClass("active");
					l.addClass("active")
				}
				k.parent().remove();
				a(j).remove();
				b.closeClass();
				return b
			},
			delOtherTab : function() {
				h.find(".nav-tabs li").not('.active,.noColeClass').remove();
				h.find(".tab-content div").not('.tab-pane.active,.tab-pane.noColeClass').remove();
				//关闭其它后，定位到当前active的那个tab
				var activeTabId = h.find(".nav-tabs li.active a").attr('href').replace('#','');
				b.setActTab(activeTabId);
				b.locationTab(activeTabId);
				return b
			},
			delAllTab : function() {
				h.find(".nav-tabs li").not('.noColeClass').remove();
				h.find(".tab-content div").not('.noColeClass').remove();
				//关闭全部后，定位到首页noColeClass的那个tab
				var homeTabId = h.find(".nav-tabs li.noColeClass a").attr('href').replace('#','');
				b.setActTab(homeTabId);
				b.locationTab(homeTabId);
				return b
			},
			setActTab : function(i) {
				i = i == undefined ? b.getActiveId() : i;
				i = i.indexOf("#") > -1 ? i : "#" + i;
				h.find(".active").removeClass("active");
				h.find("[href='" + i + "']").parent().addClass("active");
				h.find(i).addClass("active");
				return b
			},
		};
		var f = {
			onLocationTab : function() {
				h.on("click", ".tab-location", function() {
					b.locationTab();
				});
				return f
			},
			onTabClose : function() {
				h.on("click", ".tab-close", function() {
					var i = a(this).parent().attr("href");
					b.delTab(i);
				});
				return f
			},
			onTabCloseOpt : function() {
				h.on("click", ".tab-close-current", function() {
					b.delTab();
					b.closeClass();
				});
				return f
			},
			onTabCloseOther : function() {
				h.on("click", ".tab-close-other", function() {
					b.delOtherTab();
				});
				return f
			},
			onTabCloseAll : function() {
				h.on("click", ".tab-close-all", function() {
					b.delAllTab()
				});
				return f
			},
			onTabRollLeft : function() {
				//改成roll-nav-left-a2，原来是roll-nav-left-a
				h.on("click", ".roll-nav-left-a2", function() {
					if (b.getAllTabWidth() <= e.rollWidth/2) {
						return false
					}
					var i = a(this).parent().find(".content-tabs-container");
					var j = i.css("marginLeft").replace("px", "");
					var k = parseFloat(j) + b.getMarginStep() + 104;
					i.css("margin-left", k > 104 ? 104 : k)
				});
				return f
			},
			onTabRollRight : function() {
				//改成roll-nav-right3，原来是roll-nav-right
				h.on("click", ".roll-nav-right3", function() {
					if (b.getAllTabWidth() <= e.rollWidth/2) {
						return false
					}
					var i = a(this).parent().find(".content-tabs-container");
					var j = i.css("marginLeft").replace("px", "");
					var k = parseFloat(j) - b.getMarginStep();
//					alert("b.getAllTabWidth():"+b.getAllTabWidth()+";Math.abs(j):"+Math.abs(j)+";e.rollWidth"+e.rollWidth);
//					if (b.getAllTabWidth() - Math.abs(j) <= e.rollWidth) {
					if (b.getAllTabWidth() - 60 <= e.rollWidth) {
						return false
					}
					i.css("margin-left", k)
				});
				return f
			},
			onTabList : function() {
				h.on("click", ".right-nav-list", function() {
					var i = b.getTabList();
					var j = [];
					a.each(i, function(k, l) {
						var endIndex = 7;
						if(l.title.length < 7){
							endIndex = l.title.length;
						}
						j.push('<li class="toggle-tab" data-id="' + l.id + '" title="'+l.title+'">'
								+ l.tabNm.substring(0, endIndex) + "</li>")
					});
					h.find(".tab-list").html(j.join(""))
				});
				h.find(".tab-list-scrollbar").scrollbar();
				f.onTabListToggle();
				return f
			},
			onTabListToggle : function() {
				h.on("click", ".toggle-tab", function() {
					var i = a(this).data("id");
					b.setActTab(i).locationTab(i)
				});
				return f
			},
			onClickTab : function() {
				//tab左键点击事件
				h.on("click", ".nav-tabs li", function(e) {
					//设个定时，等别的地方样式更换完再改close的样式
					setTimeout(function(){
						b.closeClass();
					},200)
				});
				return f
			},
			onTabMouseover : function() {
				//tab鼠标悬浮事件
				h.on("mouseover", ".nav-tabs li", function(e) {
					if($(this).hasClass('active')){
						return f;
					}
					//不是当前选中的才要处理,显示悬浮的close
					$(this).find('.tab-close').removeClass('noselected');
					$(this).find('.tab-close').addClass('selected');
					//隐藏当前悬浮tab和它紧跟的下一个tab的.self-left-boder
					$(this).find('.self-left-boder').css('border-left','0px solid #ccc');
					$(this).next().find('.self-left-boder').css('border-left','0px solid #ccc');
				});
				return f
			},
			onTabMouseout : function() {
				//tab鼠标离开事件
				h.on("mouseout", ".nav-tabs li", function(e) {
					if($(this).hasClass('active')){
						return f;
					}
					//不是当前选中的才要处理，隐藏悬浮的close
					$(this).find('.tab-close').removeClass('selected');
					$(this).find('.tab-close').addClass('noselected');
					//显示当前离开悬浮tab和它紧跟的下一个tab的.self-left-boder
					$(this).find('.self-left-boder').css('border-left','1px solid #ccc');
					$(this).next().find('.self-left-boder').css('border-left','1px solid #ccc');
					//还有active的要处理
					//当前选中的、和它后面紧跟的tab的.self-left-boder隐藏掉
					$('.nav-tabs .self-left-boder').css('border-left','1px solid #ccc');
					$('.nav-tabs .active .self-left-boder').css('border-left','0px solid #ccc');
					$('.nav-tabs .active').next().find('.self-left-boder').css('border-left','0px solid #ccc');
				});
				return f
			},
		};
		b.init();
		return b
	}
})(jQuery);
